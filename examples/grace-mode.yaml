name: Grace mode - serve stale content on backend failure

backends:
  default:
    status: 200
    headers:
      Content-Type: "text/html"
      Cache-Control: "max-age=30"
    body: "Article content v1"

scenario:
  # Step 1: Initial request at t=0s - cache the content
  - at: "0s"
    request:
      url: /article
    expectations:
      response:
        status: 200
        body_contains: "Article content v1"
      cache:
        hit: false

  # Step 2: Request at t=15s - but still within TTL
  - at: "15s"
    request:
      url: /article
    expectations:
      response:
        status: 200
        body_contains: "Article content v1"
      cache:
        hit: true

  # Step 3: Request at t=35s - TTL expired, backend fails
  # Varnish serves stale content from grace period
  - at: "35s"
    request:
      url: /article
    backends:
      default:
        failure_mode: failed
    expectations:
      response:
        status: 200
        body_contains: "Article content v1"
      cache:
        hit: true
